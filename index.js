'use strict';

let proj4 = require('proj4');

function LoadGeoJson() {
    let fs = require('fs');
    let json = JSON.parse(fs.readFileSync('data.geojson', 'utf8'));
    return json;
}

function SaveGeoJson(json) {
    let fs = require('fs');
    let data = JSON.stringify(json /*, 1, '\t'*/);
    fs.writeFileSync('new.geojson', data);
}

function transform(xy) {
    let projSource = "+title= Московская СК (МГГТ)    +proj=tmerc +lat_0=55.66666666667 +lon_0=37.5 +k=1 +x_0=16.098 +y_0=14.512 +ellps=bessel +towgs84=316.151,78.924,589.650,-1.57273,2.69209,2.34693,8.4507 +units=m +no_defs";
    let projDest = proj4.defs('WGS84');
    return proj4(projSource, projDest, xy);
}

function transform_array(item) {
    if (Array.isArray(item)) {
        if (item.length == 2) {
            if (!Array.isArray(item[0]) && !Array.isArray(item[1])) {
                return transform(item);
            }
        }

        var newArray = [];
        item.forEach(function (sub_array) {
            newArray.push(transform_array(sub_array));
        });

        return newArray;
    }
    return item;
}

// var coordinates = [[[[-2831.7914, -851.922499999], [-2831.6468, -851.1875], [-2831.5908, -850.8189], [-2831.5789, -850.5254], [-2815.3429, -862.149599999], [-2815.7976, -862.201099999], [-2816.1532, -862.297900001], [-2816.8882, -862.5384], [-2803.7857, -871.196900001], [-2671.4738, -952.6108], [-2670.9577, -955.775], [-2666.078, -958.953400001], [-2662.9824, -957.771600001], [-2662.5271, -957.6284], [-2662.0654, -957.541999999], [-2661.5967, -957.511299999], [-2661.1277, -957.536800001], [-2660.665, -957.6182], [-2660.2154, -957.7543], [-2659.7802, -957.9452], [-2659.6783, -957.999500001], [-2635.8651, -972.538899999], [-2635.4244, -972.793500001], [-2634.9691, -973.027899999], [-2634.5031, -973.2401], [-2634.0273, -973.429400001], [-2633.543, -973.5955], [-2633.0511, -973.7379], [-2632.553, -973.8564], [-2632.0497, -973.9507], [-2631.5435, -974.020300001], [-2631.2172, -974.052100001], [-2630.7143, -974.0899], [-2630.212, -974.121099999], [-2629.7093, -974.1458], [-2629.2064, -974.163899999], [-2628.7033, -974.1756], [-2628.2001, -974.180600001], [-2627.6969, -974.179199999], [-2627.1942, -974.1712], [-2626.9935, -974.166200001], [-2626.4833, -974.137499999], [-2625.9723, -974.0792], [-2625.4655, -973.991599999], [-2624.9646, -973.875], [-2624.4712, -973.729800001], [-2623.987, -973.556500001], [-2623.5135, -973.355699999], [-2623.0523, -973.128], [-2622.605, -972.874199999], [-2622.173, -972.595100001], [-2621.7578, -972.2916], [-2621.3607, -971.9648], [-2620.983, -971.615700001], [-2620.628, -971.247500001], [-2620.5556, -971.166999999], [-2620.2234, -970.7904], [-2619.8943, -970.4113], [-2619.5682, -970.0297], [-2619.2452, -969.645500001], [-2618.9251, -969.2589], [-2618.6081, -968.8697], [-2618.2941, -968.4781], [-2617.9832, -968.084000001], [-2617.6755, -967.6876], [-2617.4739, -967.4244], [-2617.1758, -967.0097], [-2616.8996, -966.576300001], [-2616.648, -966.1283], [-2616.4217, -965.6669], [-2616.2216, -965.193600001], [-2616.0481, -964.709899999], [-2615.9022, -964.218499999], [-2615.8258, -963.9111], [-2615.7202, -963.413699999], [-2615.6318, -962.912799999], [-2615.5606, -962.4092], [-2615.5069, -961.9035], [-2615.4706, -961.396199999], [-2615.4518, -960.8879], [-2615.4506, -960.3793], [-2615.4668, -959.870999999], [-2615.5006, -959.363500001], [-2615.5518, -958.8575], [-2615.6205, -958.353599999], [-2615.7064, -957.852299999], [-2615.8096, -957.3543], [-2615.9298, -956.860099999], [-2616.0671, -956.3704], [-2616.2211, -955.8857], [-2616.3913, -955.407600001], [-2616.4798, -955.1779], [-2616.6787, -954.708000001], [-2616.9014, -954.2467], [-2617.1466, -953.7969], [-2617.4137, -953.3598], [-2617.702, -952.9363], [-2618.0108, -952.5276], [-2618.3394, -952.1346], [-2618.687, -951.758199999], [-2619.0527, -951.399499999], [-2619.4356, -951.0592], [-2619.8348, -950.7382], [-2620.2494, -950.4373], [-2620.6783, -950.157199999], [-2621.1191, -949.8994], [-2621.3174, -949.7927], [-2621.7405, -949.5352], [-2622.1753, -949.280099999], [-2622.6141, -949.032099999], [-2623.057, -948.791300001], [-2623.5037, -948.557700001], [-2623.9541, -948.331499999], [-2624.4082, -948.112600001], [-2624.8657, -947.9012], [-2625.3267, -947.6972], [-2625.7906, -947.5009], [-2626.1157, -947.3684], [-2626.6324, -947.262800001], [-2627.1334, -947.1775], [-2627.6369, -947.1087], [-2628.1425, -947.056500001], [-2628.6494, -947.0211], [-2629.1573, -947.0024], [-2629.6655, -947.000399999], [-2630.1735, -947.0152], [-2630.6808, -947.046800001], [-2631.1865, -947.095000001], [-2631.629, -947.1511], [-2653.4667, -950.000700001], [-2653.9527, -950.0491], [-2654.437, -950.067399999], [-2654.9214, -950.0561], [-2655.4043, -950.0151], [-2655.8837, -949.944599999], [-2656.358, -949.844900001], [-2656.8285, -949.715500001], [-2656.8778, -949.699999999], [-2657.3537, -949.5492], [-2657.8296, -949.397299999], [-2658.3052, -949.2446], [-2658.7805, -949.091], [-2659.2556, -948.9365], [-2659.7303, -948.781099999], [-2660.2048, -948.6248], [-2660.6789, -948.467599999], [-2661.1677, -948.3046], [-2674.1115, -940.2783], [-2794.3967, -866.1801], [-2821.3241, -847.6381], [-2826.4815, -843.467700001], [-2837.062, -833.499600001], [-2851.8459, -816.289799999], [-2866.5883, -795.840500001], [-2909.4576, -727.4044], [-2939.4763, -679.5713], [-2967.7999, -634.1691], [-2996.3247, -588.574899999], [-2996.4789, -588.132099999], [-2996.6303, -587.661800001], [-2996.7704, -587.187999999], [-2996.8992, -586.710999999], [-2997.0166, -586.2312], [-2997.1227, -585.748600001], [-2997.2172, -585.263699999], [-2997.3002, -584.776699999], [-2997.3716, -584.2875], [-2997.4178, -583.916099999], [-2997.4302, -583.442], [-2997.3922, -582.9705], [-2997.3042, -582.5056], [-2997.1673, -582.0528], [-2996.983, -581.617000001], [-2996.7534, -581.203400001], [-2996.4811, -580.816500001], [-2996.167, -580.4582], [-2996.0015, -580.2973], [-2995.6285, -579.980599999], [-2995.245, -579.6667], [-2994.8561, -579.3596], [-2994.4618, -579.0594], [-2994.0622, -578.7663], [-2993.6574, -578.4803], [-2992.3902, -577.6174], [-3018.3882, -581.1357], [-3016.3147, -581.4991], [-3015.825, -581.6066], [-3015.5554, -581.650800001], [-3015.0761, -581.7481], [-3014.6034, -581.8684], [-3014.1373, -582.011700001], [-3013.6787, -582.1777], [-3013.2287, -582.365900001], [-3012.7885, -582.5759], [-3012.3592, -582.8071], [-3011.9416, -583.0592], [-3011.5369, -583.3313], [-3011.146, -583.623], [-3010.7833, -583.9223], [-3006.6105, -588.9473], [-2999.2841, -600.686899999], [-2999.9621, -601.1097], [-2998.3591, -603.680400001], [-2997.6784, -603.2601], [-2985.0218, -623.557700001], [-2985.6557, -623.953], [-2984.0524, -626.5242], [-2983.4099, -626.123199999], [-2975.1025, -639.434599999], [-2970.6875, -646.515000001], [-2971.3339, -646.918099999], [-2969.5301, -649.585200001], [-2969.0544, -649.134099999], [-2956.5276, -669.2235], [-2957.166, -669.6216], [-2955.5626, -672.193], [-2954.9242, -671.7949], [-2947.1952, -684.1899], [-2942.2284, -692.1205], [-2942.8664, -692.518300001], [-2941.263, -695.0898], [-2940.62, -694.6888], [-2927.8351, -715.102700001], [-2928.473, -715.500499999], [-2926.8696, -718.071900001], [-2926.2266, -717.6709], [-2913.529, -737.9454], [-2914.167, -738.3432], [-2912.5636, -740.9146], [-2911.9205, -740.513699999], [-2899.1633, -760.8835], [-2899.8012, -761.281300001], [-2898.1978, -763.852700001], [-2897.5548, -763.4517], [-2883.71, -785.5579], [-2884.348, -785.955800001], [-2882.7446, -788.5272], [-2882.1015, -788.1262], [-2874.2355, -800.686000001], [-2869.5646, -807.713099999], [-2870.1967, -808.1073], [-2868.593, -810.679199999], [-2867.8872, -810.2366], [-2860.9046, -820.7414], [-2857.1375, -825.501], [-2853.5415, -829.7621], [-2854.1196, -830.2392], [-2852.1909, -832.5766], [-2851.587, -832.078], [-2844.0196, -841.0449], [-2831.7914, -851.922499999]], [[-2649.6587, -955.379899999], [-2630.6131, -952.9527], [-2630.1254, -952.9034], [-2629.6391, -952.879799999], [-2629.1522, -952.8816], [-2628.6661, -952.9088], [-2628.182, -952.9614], [-2627.7014, -953.039100001], [-2627.2225, -953.1424], [-2627.1928, -953.149700001], [-2626.7244, -953.282600001], [-2626.2698, -953.445599999], [-2625.8273, -953.639], [-2625.3989, -953.862], [-2624.9866, -954.113500001], [-2624.5923, -954.3924], [-2624.2178, -954.6973], [-2623.8649, -955.027000001], [-2623.5343, -955.3806], [-2623.3034, -955.658500001], [-2622.9736, -956.0348], [-2622.6566, -956.413899999], [-2622.3486, -956.8002], [-2622.0497, -957.1938], [-2621.7598, -957.594599999], [-2621.6032, -957.8201], [-2621.4539, -958.251800001], [-2621.3278, -958.717800001], [-2621.234, -959.191299999], [-2621.1728, -959.6702], [-2621.1446, -960.152100001], [-2621.1495, -960.6348], [-2621.1877, -961.1198], [-2621.1911, -961.148800001], [-2621.3349, -961.601399999], [-2621.4899, -962.0744], [-2621.6492, -962.546], [-2621.8128, -963.016000001], [-2621.9807, -963.4846], [-2622.1505, -963.945499999], [-2622.3277, -964.4004], [-2622.5355, -964.8343], [-2622.7753, -965.251399999], [-2623.0457, -965.6493], [-2623.3452, -966.025699999], [-2623.6722, -966.378599999], [-2624.0247, -966.706], [-2624.4008, -967.005899999], [-2624.8002, -967.278000001], [-2625.0245, -967.4123], [-2625.4553, -967.6329], [-2625.8994, -967.827099999], [-2626.3544, -967.993899999], [-2626.8188, -968.1326], [-2627.2908, -968.242799999], [-2627.7686, -968.324100001], [-2628.2505, -968.3761], [-2628.7384, -968.3989], [-2628.7483, -968.399], [-2629.2365, -968.391000001], [-2629.7198, -968.353499999], [-2630.1998, -968.286599999], [-2630.6749, -968.1906], [-2631.1433, -968.0659], [-2631.6036, -967.912799999], [-2632.0029, -967.754000001], [-2632.4575, -967.5571], [-2632.9136, -967.3561], [-2633.3682, -967.152100001], [-2633.8216, -966.9451], [-2634.2735, -966.735099999], [-2634.7241, -966.5222], [-2635.1733, -966.306299999], [-2635.621, -966.087400001], [-2636.0673, -965.865700001], [-2636.5122, -965.641000001], [-2636.9555, -965.4134], [-2637.3974, -965.1829], [-2637.8377, -964.9495], [-2638.2765, -964.713199999], [-2638.7137, -964.474099999], [-2639.1494, -964.232100001], [-2639.5834, -963.987199999], [-2640.0158, -963.739499999], [-2640.4466, -963.4889], [-2640.8758, -963.2355], [-2641.3033, -962.9794], [-2641.729, -962.7204], [-2642.1531, -962.4586], [-2642.5755, -962.1941], [-2642.9961, -961.9268], [-2643.4149, -961.6567], [-2643.832, -961.3839], [-2644.2472, -961.1083], [-2644.6607, -960.8301], [-2645.0723, -960.5491], [-2645.482, -960.2655], [-2645.8899, -959.9791], [-2646.2959, -959.690099999], [-2646.7, -959.398399999], [-2647.1021, -959.1041], [-2647.5024, -958.8072], [-2647.9006, -958.5076], [-2648.2969, -958.205399999], [-2648.6912, -957.900599999], [-2649.0835, -957.5933], [-2649.4738, -957.283399999], [-2649.8623, -956.970699999], [-2649.966, -956.886499999], [-2650.243, -956.5605], [-2650.3776, -956.176999999], [-2650.3732, -955.861199999], [-2650.1306, -955.5986], [-2649.7526, -955.403999999], [-2649.6587, -955.379899999]]]];
// console.log('result:', transform_array(coordinates)[0]);

console.log('load geo json');
let geoJson = LoadGeoJson();
// var xy = transform([11931.494998806, 21686.985251669]);
// console.log(xy);

console.log('process records');
let newJson = {};
newJson.type = geoJson.type;
newJson.crs = {
    type: "name",
    properties: {
        name: "urn:ogc:def:crs:OGC:1.3:CRS84"
    }
};
newJson.features = [];

let n = 0;
geoJson.features.forEach(function (feature) {
    if (n >= 3500) {
        let newFeature = {};
        let newProps = {};

        newFeature.type = feature.type;

        // newProps.feature_id = feature.properties.feature_id;
        newProps.objectid = feature.properties.OBJECTID;
        newProps.uidnftn = feature.properties.UIDNFTN;
        // newProps.name = feature.properties.NAME;
        newProps.address = feature.properties.ADDRESS;
        newProps.customer = feature.properties.CUSTOMER;
        newProps.cleaning_category = feature.properties.CLEANING_CATEGORY;
        newProps.busstop_count = feature.properties.BUSSTOP_COUNT;
        newProps.sidewalk_square = feature.properties.SIDEWALK_SQUARE;
        newProps.carriageway_square = feature.properties.CARRIAGEWAY_SQUARE;
        newProps.total_square = feature.properties.TOTAL_SQUARE;
        // newProps.centroid = feature.properties.centroid;
        // newProps.centroid.coordinates = transform(feature.properties.centroid.coordinates);

        newFeature.properties = newProps;
        newJson.features.push(newFeature);

        newFeature.geometry = feature.geometry;
        newFeature.geometry.coordinates = transform_array(feature.geometry.coordinates);
        // newFeature.geometry_name = feature.geometry_name;
    }
    n++;
});

console.log('write geo json');
SaveGeoJson(newJson);

console.log('done');
